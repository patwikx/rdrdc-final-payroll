# Project To-Do

Last updated: 2026-02-12

## Completed

- [x] Implemented HR final-stage Approval Queue actions for leave and overtime.
  - Approve/reject server actions with remarks/reason.
  - Final-stage role checks (`COMPANY_ADMIN`, `HR_ADMIN`, `PAYROLL_ADMIN`, optional `SUPER_ADMIN`).
  - Status transitions from `SUPERVISOR_APPROVED` to `APPROVED`/`REJECTED`.
  - HR-stage field updates and audit logging.
- [x] Wired Approval Queue UI to real actions.
  - Added details drawer (supervisor remarks, filed date, schedule/duration, reason).
  - Added approve/reject dialogs with required notes and queue refresh.
- [x] Simplified admin sidebar Leave & Overtime submenu to focus on `Approval Queue`.
- [x] Implemented Employee Portal route group and access control.
  - Added `/${"{companyId}"}/employee-portal/*` layout and pages.
  - Enforced EMPLOYEE-only company-scoped routing to portal.
- [x] Implemented employee self-service leave and overtime actions.
  - Create/cancel leave requests.
  - Create/cancel overtime requests.
  - Company-scoped authz + validation + audit logging.
- [x] Implemented interactive Employee Payslips UI.
  - Payslip details dialog.
  - Pagination and summary cards.
- [x] Implemented server-side payslip PDF downloads.
  - Playwright HTML/CSS renderer.
  - Tenant-safe employee-scoped download route.
- [x] Expand automated test coverage across modules. (Closed per current product direction)
  - Treat current coverage scope as sufficient for this phase.
  - Re-open only when explicitly prioritized for another hardening sprint.

## Next

- [x] Implement leave balance yearly initialization (priority).
  - Added company-scoped, year-scoped initialization action (`Asia/Manila` year semantics) in settings leave/overtime module.
  - Resolves entitlement from `LeavePolicy` by employee employment status with proration support.
  - Seeds `LeaveBalance` rows idempotently for active employees and active leave types.
  - Writes `LeaveBalanceTransaction` rows for carry-over and year entitlement initialization.
- [x] Add automated yearly trigger for leave balance initialization. (Skipped by product decision)
  - Manual yearly initialization from Settings remains the official operating flow.
  - Keep admin manual action as fallback and rerun-safe path.
- [x] Implement leave balance lifecycle updates on leave request transitions.
  - Completed with tenant-scoped transaction-safe mutations and ledger updates.
- [x] Extend balance lifecycle parity to any remaining leave approval endpoints and overtime-specific rules.
  - Added overtime-to-CTO conversion on HR final approval for employees who are not overtime-eligible or are supervisor-and-up (detected via direct reports).
  - Conversion is 1:1 and enforces minimum 1 hour OT request duration.
- [x] Move Settings > Leave / OT Policies from static UI to DB-backed CRUD.
  - Persisted leave type and policy changes with typed validation and authz checks.
  - Added overtime policy persistence through `OvertimeRate` settings actions (global model with company-scoped settings access checks).
- [x] Add integration tests for leave and overtime request actions. (Skipped by product decision)
  - Deferred for now to prioritize feature completion.
- [x] Add audit metadata (`IP`, `User-Agent`) for payslip download route.
- [x] Add branded payslip PDF enhancements.
  - Added company logo support, signatory blocks, and optional watermark (`PAYSLIP_PDF_WATERMARK`).
- [x] Expand employee self-service profile editing.
  - Expanded update flow to include contact, address, emergency contact, and document entries.
  - Added typed validation and audit log entries for self-service profile mutations.
- [x] Build active Payroll module workflow using project code structure (aligned to reference business logic).
  - [x] Added initial active payroll routes: `/[companyId]/payroll`, `/[companyId]/payroll/runs`, `/[companyId]/payroll/runs/new`, `/[companyId]/payroll/runs/[runId]`.
  - [x] Added core payroll lifecycle server actions scaffold: `create`, `validate`, `calculate`, `close`, `reopen`.
  - [x] Added validation utility integration with pre-payroll checks (concurrent run guard, step sequencing, employee readiness, DTR/leave/overtime diagnostics summary).
  - [x] Upgraded `calculatePayrollRunAction` toward Payroll Phase 1 parity.
    - Added richer attendance/pay computation (rest day, holiday, paid leave, overtime multipliers, night diff, tardiness/undertime rules).
    - Added statutory deductions (`SSS`, `PhilHealth`, `Pag-IBIG`, withholding tax) with semi-monthly split behavior.
    - Aligned withholding tax computation to active statutory WTAX flex-rule rows (`TaxTable`) for applicable pay frequency.
    - Added recurring deduction applicability and percentage-base handling (`GROSS`/`BASIC`/`NET`).
    - Added loan amortization deduction posting with payroll-linked loan payments and loan balance/status updates.
    - Preserved prior manual payslip adjustments across recalculation reruns.
    - Added structured payslip line items (`PayslipEarning`, `PayslipDeduction`) and stronger process step transitions.
    - Added configurable statutory deduction timing policy in payroll settings and wired calculation to policy-driven contribution timing.
  - [x] Added active `/[companyId]/payroll/adjustments` route and module actions.
    - Added payslip-level manual adjustment UI (earning/deduction) scoped to selected payroll run.
    - Added company-scoped add/remove adjustment actions with review-stage guardrails.
    - Added payslip + payroll run totals recomputation and audit logging after adjustment mutations.
  - [x] Added active `/[companyId]/payroll/payslips` routes and view models.
    - Added payslip listing route with payroll-run filtering.
    - Added payslip detail route (`/[payslipId]`) with earnings/deductions breakdown.
    - Added direct flow links between payslips and adjustments for review-stage operations.
  - [x] Added active `/[companyId]/payroll/statutory` route and run-level reporting.
    - Added statutory summary totals (employee + employer shares and WTAX) per selected run.
    - Added employee-level statutory contribution breakdown table with direct payslip links.
  - [x] Implemented payroll run lifecycle stage progression hardening (`review -> generate payslips -> close`).
    - Added `completeReviewPayrollRunAction` with stricter step gating (requires step 3 complete).
    - Added `generatePayslipsPayrollRunAction` with stricter step gating (requires step 4 complete + payslip records).
    - Tightened close-run gating so step 5 must be completed before close is allowed.
  - [x] Reworked run detail UX flow to match reference step experience using project design defaults.
    - Added process stepper + step-focused views (validate, calculate, review/adjust, generate payslips, close).
    - Added richer review register table with discrepancy filtering, expandable breakdown rows, and adjustment flow link.
  - [x] Applied payroll run UX polish pass based on review feedback.
    - Removed duplicate run header at run-detail page level.
    - Removed run snapshot section from run detail flow.
    - Refined validation log container styling (non-sharp edges) and normal loading animation.
    - Reduced process stepper visual height for denser layout.
    - Rounded stepper icon containers and increased step label typography size for readability.
    - Updated review-step adjust action to open inline payslip adjustment dialog (reference-like flow) instead of route redirect.
    - Updated adjustment dialog type control to switch-based toggle and aligned type+amount into a 3-column layout row.
    - Switched adjustment type control back to shadcn `Select` and enforced full-width select trigger.
    - Added adjustment-type visual icons in select trigger and options for clearer earning vs deduction context.
    - Fixed adjustment-type select icon duplication by keeping icon only in selected value area.
    - Updated adjustment dialog form grid to 2-column layout for type + amount alignment.
    - Updated review-step UI to remove sharp edges, improve confirmation-checkbox visibility, and highlight expanded rows using default primary accent tones.
    - Updated review-step `READY` badge to a clearer true-green visual state.
    - Updated review-step currency display to `PHP` code format instead of peso sign.
    - Updated payslip `Adjust` dialog trigger button styling to a blue primary action state.
  - [x] Added statutory deduction diagnostics in validation/calculation notes for payroll troubleshooting.
    - Validation notes now include statutory schedule applicability and active table counts per deduction type.
    - Calculation notes now include statutory application/skipped/no-bracket diagnostics per employee aggregate.
    - Run detail UI now surfaces calculation statutory diagnostics summary for quick troubleshooting.
    - Fixed statutory table matching logic to use effective date range overlap (including historical inactive versions) instead of `isActive`-only filtering.
  - [x] Fixed validation-to-calculation progression gating.
    - Validation action now stays on step 2 after successful validation to allow review time.
    - Added explicit `proceedToCalculatePayrollRunAction` and "Proceed to Next Step" button in Validate step.
  - [x] Applied same explicit progression gating to calculation-to-review transition.
    - Calculation action now remains on step 3 after successful run so users can review computed output.
    - Added `proceedToReviewPayrollRunAction` and "Proceed to Next Step" button in Calculate step.
    - Added employee-level calculated payroll summary table after calculation completes.
    - Removed calculation statutory diagnostics strip from run detail to keep calculate review focused on employee outputs.
    - Rounded calculate-step containers to avoid sharp-edge visuals.
  - [x] Updated Validate step review output for attendance-centric validation review.
    - Removed statutory diagnostics block from latest validation summary panel.
    - Added validated employee attendance summary table (present, absent, tardiness, undertime, OT, CTO conversion hours).
    - Added backward-compatible fallback rendering for legacy validation notes missing CTO/OT fields.
    - Removed "Latest Validation Summary" title header text while keeping error/warning chips visible.
    - Removed non-actionable error/warning count chips from Validate step panel.
  - [x] Reworked payroll runs list page UX closer to reference layout (within project design system).
    - Added runs list client with search + status filter controls and workflow progress column.
    - Updated runs table structure to reference-style columns/actions (`Cycle Reference`, `Cutoff`, `Workflow Progress`, `Aggregate Payout`, `Status`, action menu).
    - Added runs page stat cards and normalized controls to default field/button sizing and default color usage.
    - Removed remaining custom sizing overrides on runs search/filter controls to strictly use default input/button sizes.
    - Added proper icons to run stat cards and switched aggregate currency display to `PHP` code format.
    - Replaced runs-page "New Payroll Run" page navigation flow with in-page dialog-based create flow.
    - Added default pay-period auto-selection in create dialog/form based on current open pay period (PH-local date), with next open period fallback.
    - Revised create-run pay period defaulting to earliest OPEN period ordered by cutoff (lock-state progression), not current date.
    - Replaced pay-period selector in create-run form with disabled display field to enforce system-selected period.
    - Added pay-period policy tooltip in create-run form explaining unlocked-period auto-selection behavior.
  - [x] Updated statutory tables effective date input to shadcn `Calendar` popover date picker.
  - [x] Removed card-like container wrappers from statutory tables quick-setup and bracket sections.
  - [x] Removed redundant `effectiveYear` input from statutory tables; year is now derived from `effectiveFrom` date on save/preset logic.
  - [x] Moved `effectiveFrom` calendar control beside flex-rule actions in each statutory section and removed standalone Quick Setup labels block.
  - [x] Updated generate-payslips progression to require explicit proceed action before moving to Close step.
    - Added `proceedToClosePayrollRunAction` and updated Step 5 UI to show `Proceed to Next Step` only after successful payslip generation.
    - Generate action no longer auto-advances from step 5 to step 6.
  - [x] Rounded final-step payroll run cards/containers to remove sharp-edge visuals in Generate Payslips and Close Run steps.
  - [x] Moved `Export Payroll Register` action from Close step to Review step.
    - Close step now contains only finalization actions.
    - Review step now owns payroll register export entry point (current placeholder button).
  - [x] Added close-period confirmation and locked-state UX on Close step.
    - `Close Pay Period` now opens an alert dialog confirmation before action execution.
    - After successful close, Close step indicates the period is already locked and disables close action.
    - Center-aligned critical action and locked-state message copy for close-step visual consistency.
    - Centered `Period Locked` button placement and changed close-step summary amounts to `PHP` display format.
  - [x] Updated payroll run status presentation for locked periods.
    - Closed runs now display `LOCKED` status label (with lock icon) in run list and run detail header.
    - Replaced vertical status card in run detail header with compact horizontal icon badge.
    - Preserved underlying DB enum state as `PAID` while deriving `LOCKED` from pay-period lock state.
  - [x] Fixed Calculate step summary visibility after running payroll calculation.
    - Calculated employee summary list now stays visible after successful calculation completion.
    - Removed UI condition that hid summary when local progress state remained non-zero after refresh.
  - [x] Added Review-step payroll register report generation.
    - Replaced review-step export placeholder with active `Generate Payroll Register Report` action.
    - Added report preview/print page: `/[companyId]/payroll/runs/[runId]/report`.
    - Added CSV export route: `/[companyId]/payroll/runs/[runId]/report/export`.
    - CSV output follows reference register structure: grouped by department, department sub-totals, and grand total rows with reference-aligned BAS/SSS/PHI/HDMF/TAX/SSSL/ALW/OTH/ABS/LTE/UT/NET columns.
    - Added print action on report page to support reference-aligned register printing workflow.
    - Added audit logging for payroll register export events.
    - Updated report page UX: removed card-like header container, added `Back to Review` button, and styled actions with solid blue `Print` and solid green `Export CSV` buttons.
    - Updated print behavior to open and print a document-style payroll register layout (instead of printing full webpage chrome).
    - Added reference-style `LEGEND` section to both report preview and print output.
    - Moved `Generate Payroll Register Report` button to the top of the Review-step Run Totals card container.
    - Updated `Generate Payroll Register Report` button style to solid blue.
    - Moved `Generate Payroll Register Report` button outside and above the Run Totals card container.
    - Replaced the Review-step `Discrepancies` toolbar button with `Generate Payroll Register Report` and aligned search/report toolbar control heights.
    - Updated employee search field to non-full-width desktop sizing (`sm:w-80`).
    - Right-aligned `Generate Payroll Register Report` to the end of the top Review-step toolbar row on desktop.
  - [x] Reworked payslip PDF template for reference parity.
    - Updated download/email payslip output template to mirror the payslip-template preview reference layout (clean white format, simplified header, employee/pay-period blocks, split earnings and deductions, and net-pay strip).
    - Fixed earnings rendering to prevent duplicate `Basic Pay` line item.
    - Updated deductions presentation to show pay-period statutory deductions plus attendance deductions when present (`Late/Tardiness`, `Undertime`).
    - Corrected displayed `Basic Pay` amount in template output to show semi-monthly half of employee monthly base salary.
    - Reduced deductions line-item typography and standardized footer label to `Total Deductions`.
    - Aligned earnings/deductions column row heights so `Gross Pay` and `Total Deductions` separators/totals sit on the same horizontal line.
    - Standardized attendance deduction display in payslip output to `Tardiness` label.
  - [x] Added admin payslip delivery actions in payroll flows.
    - Added admin download endpoint for payroll payslip PDF: `/[companyId]/payroll/payslips/[payslipId]/download`.
    - Added Generate-step actions for direct in-step payslip delivery: `Download All Payslips`, per-employee `Download`, and `Send Payslips via Email` (Resend batch send) without page redirect.
    - Added email delivery persistence/audit writes using `EmailDeliveryRecord` and `EmailAuditLog`.
    - Updated Generate-step payslip delivery action buttons to solid blue style (`Download All Payslips`, `Send Payslips via Email`, and per-employee `Download`).
    - Updated Send Payslips flow to reference-style batch delivery dialog (confirmation, progress, result summary, failed list, and retry failed sends).
    - Improved payslip email template copy to use pay-period wording (`period half` + formatted cutoff date range) instead of run-number phrasing.
    - Fixed strict TS object-literal typing issue in payslip email actions by routing PDF input through payload variables before `generatePayslipPdfBuffer` calls.
    - Added per-payslip preview-before-send modal (HTML + plain-text preview with direct send action) in Generate Payslips employee row actions.
  - [x] Fixed non-payroll build blocker in employee user access module.
    - Guarded nullable `employee.user` access in approver-update action by extracting non-null user locals after validation.
    - Removed strict-null TypeScript errors in transaction/audit updates for linked user approver toggles.
  - [x] Fixed `/logout` build blocker for `useSearchParams()` during prerender.
    - Wrapped logout client component render in `Suspense` boundary in `app/(root)/logout/page.tsx`.
  - [x] Fixed `/login` build blocker for `useSearchParams()` during prerender.
    - Wrapped login client component render in `Suspense` boundary in `app/(root)/login/page.tsx`.
  - [x] Added and executed PH-focused payroll E2E audit harness.
    - Added `scripts/payroll-ph-e2e-audit.mjs` and script alias `npm run audit:payroll:ph`.
    - Audit validates DTR/payroll consistency signals, PH statutory timing enforcement for semi-monthly periods, gross/deduction/net arithmetic integrity, lifecycle step gating, and lock-state policy consistency.
    - Latest local run audit result: `failures: 0`, `warnings: 0` (run `RUN-2026-00001`, semi-monthly first-half).
    - Updated lock-state policy assertion to require pay-period lock only for `REGULAR` runs (non-regular/trial paid runs no longer produce false-positive lock failures).
    - Executed audit sweep on all available recent runs in local dataset (currently one run: `RUN-2026-00001`) with `failures: 0`, `warnings: 0`.
  - [x] Addressed key payroll-calculation risk gaps from PH policy review.
    - Improved half-day DTR marker detection robustness (`[HALF_DAY]`, `HALF DAY`, `HALFDAY`).
    - Updated `ON_LEAVE` fallback behavior to avoid treating unmatched/unapproved leave days as payable.
    - Applied pre-tax recurring deductions to taxable income before withholding tax calculation.
  - [x] Added payroll calculation traceability metadata for enterprise-grade auditability.
    - Added `calculationVersion` and `formulaPolicy` stamping into calculation step notes.
    - Added `employeeCalculationTraces` payload for per-employee input/output explainability.
    - Extended PH payroll audit script to validate presence/readability of calculation trace metadata.
    - Added and executed legacy metadata backfill script (`npm run backfill:payroll:calc-meta`) so existing step-3 records comply with trace/version audit checks.
  - [x] Hardened payslip email security controls.
    - Escaped dynamic email-template fields and sanitized subject lines.
    - Replaced direct HTML preview rendering with sandboxed iframe preview.
    - Added server-side email send rate limit and retry cooldown guards.
  - [x] Added idempotency safeguards for close and email dispatch actions.
    - `closePayrollRunAction` now returns safe idempotent success when run is already closed and uses guarded transition updates to avoid duplicate concurrent close transitions.
    - Batch payslip send action now blocks immediate duplicate dispatch attempts within a short guard window.
  - [x] Added recurring deductions management in Payroll module.
    - Added route/page: `/[companyId]/payroll/recurring-deductions`.
    - Added recurring deductions view model + client page for create/list/search and status actions.
    - Added server actions + zod schemas for creating deductions and updating status with strict company scoping, payroll authz checks, PH-local date handling, and audit logging.
    - Added Payroll sidebar item for `Recurring Deductions`.
    - Updated deduction-type selector to exclude mandatory/government deduction types.
    - Added dynamic in-selector `Create Deduction Type` dialog flow and create action, then auto-refreshes options/selection.
    - Updated `Create Deduction Type` dialog layout: `Pay Period Applicability` + `Pre-tax deduction` in a 2-column grid.
    - Matched `Pre-tax deduction` control row height with the adjacent select component.
    - Added matched label rows and fixed control heights (`h-9`) to keep the two fields visually aligned.
    - Renamed long form label from `Pay Period Applicability` to `Payroll Timing`.
    - Removed bordered container around `Pre-tax Deduction` checkbox row for cleaner inline control styling.
    - Adjusted checkbox row spacing to align visually with adjacent select control.
    - Updated deduction-type selector options to hide statutory/system types (e.g., SSS) and display name-only labels.
    - Removed `Recurring Category` input from create form; recurring category now maps internally from selected deduction type.
    - Updated recurring-deductions page layout to match Leave / OT Policies UX pattern (left records list + right sticky form panel).
    - Added row-select editing behavior: selected record auto-populates right-side form and save button switches to update mode.
    - Added status filter button beside search and upgraded status badges to solid semantic colors.
    - Updated row action button styling to adapt against selected-row blue highlight context.
    - Placed filter button immediately beside search input in records toolbar with matched height.
    - Added `Reactivate` action path for cancelled recurring deduction records.
  - [x] Restored quality-gate pass state across repository after payroll changes.
    - Fixed lint blocker in employee movements page by replacing inline-render component declarations with render-helper functions.
    - Verified `npm run lint` passes.
    - Verified `npm run build` passes.
  - [x] Implemented bonus run calculations for payroll run types.
    - Added `THIRTEENTH_MONTH` calculation using YTD regular basic pay divided by 12.
    - Added prorated fallback for 13th month when no regular-run basic-pay history is available for the employee.
    - Added `MID_YEAR_BONUS` calculation using fixed policy formula (`baseSalary / 2`).
    - Confirmed bonus run types do not lock pay periods (pay period is context-only).
  - [x] Implemented statutory report suite with locked Iteration 3 UX.
    - Added report selector workspace and print-friendly report templates for SSS, PhilHealth, Pag-IBIG, DOLE 13th Month, and BIR Alphalist.
    - Added styled CSV exports that mirror report headings/column structures for all implemented statutory reports.
    - Added print metadata footer handling (date/time/page/user) in report print output.
    - Added report-scoped print behavior so print action renders report HTML only (not full app page).
    - Updated statutory reports source behavior:
      - Default source is `REGULAR` payroll runs.
      - Added UI switch to optionally show `TRIAL_RUN` records.
      - Trial mode is constrained to the latest trial run per pay period.
      - Monthly remittance tables consolidate to one row per employee per selected month.
  - [x] Upgraded BIR annual tax logic to align with annual WTAX-table computation flow.
    - Added annual alphalist computation (gross compensation, mandatory contributions, non-taxable benefits cap, taxable compensation, annual tax due, withheld variance).
    - Added BIR report columns for SSS/PH/PG employee share and aligned value rendering.
    - Added compact per-employee BIR calculation trace section for HR audit review.
  - [x] Refined payroll withholding tax computation to annual-projected delta method when annual WTAX rows are available.
    - Withholding now computes projected annual tax due and withholds only remaining delta after YTD withheld.
    - Preserved period-bracket fallback behavior when annual WTAX rows are not configured.
    - Fixed annual projection to include YTD pre-tax recurring deductions (not current period only).
  - [x] Reworked admin payslips history data loading to bounded API-driven slices.
    - Added `/api/payroll/payslips` endpoint with bounded page-size limits and date-scope filters.
    - Updated payslips page client to fetch paginated/date-scoped data instead of receiving full payslip arrays from RSC.
  - [x] Hardened non-fatal logging behavior in onboarding and recurring deductions actions.
    - Onboarding quick-create now returns success even if audit logging fails (with warning payload).
    - Recurring deduction action catch blocks now avoid exposing raw server/database errors to client messages.
  - [x] Updated employee movement history null-transition support.
    - Profile updates now record transitions when status/position/rank are cleared to `null`.
    - Movement history `new*Id` fields are nullable via schema + migration to preserve clear/unassign history events.
  - [x] Added employee profile History-tab dialog CRUD with current-profile sync.
    - Added dialog-based create/update/delete for Salary, Position, Employment Status, Rank, and Previous Employment history rows in `/[companyId]/employees/[employeeId]`.
    - Added typed profile history CRUD action layer + zod schemas with company-scoped authz checks, audit logging, and route revalidation.
    - Added latest-history sync behavior so salary/position/status/rank current profile values update automatically after history changes.
  - [x] Port business rules from `payroll-actions-reference/**` into `modules/payroll/**` (not direct copy, structure-aligned implementation).
  - [x] Align active UI/routes using `payroll-page-reference/**` and `payroll-components-reference/**` as behavior/layout guides.
  - [x] Complete remaining active `/[companyId]/payroll/*` routes currently linked in sidebar (`payslips`, `adjustments`, `statutory`, etc.).
  - [x] 2026-02-12 closure verification:
    - Verified sidebar payroll routes resolve to active pages (`/payroll/runs`, `/payroll/recurring-deductions`, `/payroll/payslips`, `/payroll/statutory`).
    - Verified payroll module structure (`actions`, `schemas`, `components`, `utils`) is implemented and wired.
- [x] Align DTR outputs to payroll computation inputs.
  - [x] Standardized one DTR wall-clock contract from upload (`test-dtr.txt`) to UI/edit/export/payroll consumption paths.
  - [x] Removed mixed DTR clock formatter behavior by using shared wall-clock helpers in DTR views, edit flows, schedule autofill, and CSV export.
  - [x] Added cross-midnight (overnight) handling in biometric sync and manual correction flows.
  - [x] Kept manual DTR auto-approval behavior as-is (intentional HR-only operating model).
  - [x] Gated payroll DTR consumption to approved-ready records only (validation + calculation guardrails).
  - [x] Aligned overtime source-of-truth in payroll diagnostics with approved overtime requests (payable source), while preserving anomaly checks for unapproved DTR OT entries.
  - [x] Made half-day semantics explicit with day-fraction capture and structured remarks token support (with legacy marker compatibility).

## Backlog (Lower Priority / Later)
- [x] Re-introduce Leave Reports module for payroll-source reporting when prioritized. (Skipped by product decision)
  - Deferred until explicitly re-prioritized in a future reporting sprint.
- [x] Remove remaining Employee Portal loan entry points to match current scope policy.
  - Removed Employee Portal loan quick-action and pending loan widget from portal dashboard.
  - Removed Employee Portal `/loans` and `/loan-calculator` routes from employee scope.
- [x] Formalize `modules/leave` as a full domain module (not UI-only).
  - Moved employee leave submit/cancel actions and validation schemas into `modules/leave/actions` + `modules/leave/schemas`.
  - Moved leave balance ledger mutations into `modules/leave/utils` and updated all leave-approval consumers to use module-local utilities.
  - Added leave-domain typed action result contracts and employee-portal leave read-model types under `modules/leave/types`.
  - Extracted Employee Portal dashboard leave queries into `modules/leave/utils/employee-portal-leave-dashboard-read-model.ts`.
  - Updated leave read-model loaders to enforce tenant-safe company scoping on leave reads.

## Active Queue (2026-02-12)

- [x] Implement employee lifecycle actions in Employee Profile (`Deactivate` and `Terminate`) with full flow:
  - Added overview action buttons with dialog-based confirmation/inputs for separation date, last working day, reason, and remarks.
  - Added typed server action + zod schema validation + employees-module authz checks.
  - Persists lifecycle fields (`isActive`, separation metadata, optional notes) and writes audit logs.
  - Revalidates employee list and employee profile pages after mutation.
- [x] Keep only `Sync Biometrics` for attendance exceptions for now:
  - Decommissioned legacy `modules/attendance/exceptions/**` page/view-model paths that are no longer used.
  - Kept redirect behavior from `/attendance/exceptions` -> `/attendance/sync-biometrics`.
  - Updated DTR mutation revalidation to target `/attendance/sync-biometrics` directly.
- [x] Standardize Setup Wizard UI controls to project conventions:
  - Replaced raw HTML `select` and checkbox inputs with shadcn primitives (`Select`, `Checkbox`, `Switch`) in setup wizard steps.
  - Replaced `type="date"` holiday date fields with shadcn `Calendar` + popover picker.
  - Added PH-local date conversion/display helpers (`Asia/Manila`) for setup holiday date boundaries.
- [x] Harden PH-local date/year fallback defaults across UI/report boundaries:
  - Added shared PH time helpers in `lib/ph-time.ts` (`getPhYear`, `getPhMonthIndex`, `toPhDateOnlyUtc`) for consistent defaults.
  - Replaced year/date fallbacks in statutory reports, leave-year resolution, employee portal leave/dashboard loads, company profile date-picker bounds, medical dialog year default, and sidebar year label to PH-local helpers.
  - Updated employee portal holiday query lower-bound to PH date-only UTC boundary to prevent timezone drift.
- [x] Scale User Access workspace for larger companies:
  - Replaced fixed user-access caps with server-side pagination for employee rows and company user-account rows.
  - Added URL-backed filter state (`q`, employee/system linked filters) and independent pagination state for both panels.
  - Preserved current create/link/edit/unlink and credential update flows.
- [x] Productionize remaining iteration-labeled page components and cleanup naming/lint debt.
  - Renamed active iteration-labeled module components to production names:
    - Dashboard: `dashboard-action-center-layout.tsx`, `dashboard-action-center.tsx`
    - Approvals: `approval-queue-page.tsx`
    - Leave: `leave-balance-page.tsx`
    - User Access: `user-access-page.tsx`
  - Updated all dashboard/approvals/leave/user-access route imports and component usages to new names.
  - Removed dashboard naming/lint debt by dropping unused iteration props/types and clearing remaining lint warnings.

## Decisions

- Approval model direction: keep current two-stage leave/overtime approvals and use `User.isRequestApprover` as the approver flag source.
- Approval workflow engine models are out of scope for now.
- Migration workflow note: baseline migration chain was repaired by adding a schema baseline migration and resolving historical migrations as applied for the current environment before continuing new schema updates.
- Payroll direction: use `payroll-actions-reference/**` as business-logic policy source and `payroll-page-reference/**` + `payroll-components-reference/**` as reference guides, while implementing inside this project's existing module/code structure.
- DTR decision: manual DTR auto-approval remains intentional because operational users are HR users.
